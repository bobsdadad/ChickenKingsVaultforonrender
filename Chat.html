<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArrowChat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --radius: 0.875rem;
        --primary: oklch(0.205 0 0);
        --primary-foreground: oklch(0.985 0 0);
        --secondary: oklch(0.97 0 0);
        --secondary-foreground: oklch(0.205 0 0);
        --accent: oklch(0.97 0 0);
        --accent-foreground: oklch(0.205 0 0);
        --background: oklch(1 0 0);
        --foreground: oklch(0.145 0 0);
        --card: oklch(1 0 0);
        --card-foreground: oklch(0.145 0 0);
        --muted: oklch(0.97 0 0);
        --muted-foreground: oklch(0.556 0 0);
        --border: oklch(0.922 0 0);
        --input: oklch(0.922 0 0);
        --ring: oklch(0.708 0 0);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --primary: oklch(0.922 0 0);
          --primary-foreground: #0e0e0e;
          --secondary: oklch(0.269 0 0);
          --secondary-foreground: oklch(0.985 0 0);
          --accent: #262626;
          --accent-foreground: oklch(0.985 0 0);
          --background: oklch(0.145 0 0);
          --foreground: oklch(0.985 0 0);
          --card: oklch(0.205 0 0);
          --card-foreground: oklch(0.985 0 0);
          --muted: oklch(0.269 0 0);
          --muted-foreground: oklch(0.708 0 0);
          --border: oklch(1 0 0 / 10%);
          --input: oklch(1 0 0 / 15%);
          --ring: oklch(0.556 0 0);
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      html,
      body {
        height: 100%;
        font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--background);
        color: var(--foreground);
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
        max-width: 1920px;
        margin: 0 auto;
        opacity: 0;
        animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      .sidebar {
        width: 280px;
        background: var(--card);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: slideInLeft 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes slideInLeft {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        font-size: 20px;
        font-weight: 600;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo svg {
        width: 28px;
        height: 28px;
        stroke: currentColor;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .logo:hover svg {
        transform: scale(1.1) rotate(5deg);
      }

      .settings-btn {
        background: none;
        border: none;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 8px;
        border-radius: var(--radius);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .settings-btn:hover {
        background: var(--secondary);
        color: var(--foreground);
        transform: rotate(90deg) scale(1.1);
      }

      .settings-btn:active {
        transform: rotate(90deg) scale(0.95);
      }

      .settings-btn svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
      }

      .user-info {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInLeft 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s backwards;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        color: white;
        flex-shrink: 0;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
      }

      .user-avatar:hover {
        transform: scale(1.1);
      }

      .user-details {
        flex: 1;
        min-width: 0;
      }

      .user-name {
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .user-status {
        font-size: 12px;
        color: var(--muted-foreground);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.1);
        }
      }

      .rooms-section {
        flex: 1;
        overflow-y: auto;
        padding: 16px 12px;
      }

      .rooms-section::-webkit-scrollbar {
        width: 6px;
      }

      .rooms-section::-webkit-scrollbar-track {
        background: transparent;
      }

      .rooms-section::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
        transition: background 0.2s ease;
      }

      .rooms-section::-webkit-scrollbar-thumb:hover {
        background: var(--ring);
      }

      .rooms-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 8px 12px;
      }

      .rooms-header h3 {
        font-size: 12px;
        font-weight: 600;
        color: var(--muted-foreground);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .add-room-btn {
        background: none;
        border: none;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .add-room-btn:hover {
        background: var(--secondary);
        color: var(--foreground);
        transform: scale(1.15) rotate(90deg);
      }

      .add-room-btn:active {
        transform: scale(1) rotate(90deg);
      }

      .add-room-btn svg {
        width: 18px;
        height: 18px;
      }

      .room-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        margin-bottom: 4px;
        opacity: 0;
        animation: slideInLeft 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        position: relative;
        overflow: hidden;
      }

      .room-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: var(--foreground);
        transform: scaleY(0);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .room-item:hover::before {
        transform: scaleY(1);
      }

      .room-item:nth-child(1) {
        animation-delay: 0.1s;
      }
      .room-item:nth-child(2) {
        animation-delay: 0.15s;
      }
      .room-item:nth-child(3) {
        animation-delay: 0.2s;
      }
      .room-item:nth-child(4) {
        animation-delay: 0.25s;
      }
      .room-item:nth-child(5) {
        animation-delay: 0.3s;
      }

      .room-item:hover {
        background: var(--secondary);
        transform: translateX(6px);
      }

      .room-item:active {
        transform: translateX(4px) scale(0.98);
      }

      .room-item.active {
        background: var(--accent);
        color: var(--accent-foreground);
      }

      .room-item.active::before {
        transform: scaleY(1);
      }

      .room-icon {
        width: 20px;
        height: 20px;
        color: var(--muted-foreground);
        flex-shrink: 0;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .room-item:hover .room-icon {
        transform: scale(1.1);
      }

      .room-item.active .room-icon {
        color: var(--accent-foreground);
      }

      .room-content {
        flex: 1;
        min-width: 0;
      }

      .room-name {
        font-size: 14px;
        font-weight: 500;
      }

      .online-count {
        font-size: 11px;
        color: var(--muted-foreground);
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
      }

      .online-count svg {
        width: 10px;
        height: 10px;
      }

      .room-actions {
        opacity: 0;
        display: flex;
        gap: 4px;
        transition: opacity 0.2s ease;
      }

      .room-item:hover .room-actions {
        opacity: 1;
      }

      .room-action-btn {
        background: none;
        border: none;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }

      .room-action-btn:hover {
        background: var(--muted);
        color: var(--foreground);
      }

      .room-action-btn svg {
        width: 14px;
        height: 14px;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--background);
        min-width: 0;
        position: relative;
      }

      .chat-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideDown 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes slideDown {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .chat-header-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chat-header-info h2 {
        font-size: 18px;
        font-weight: 600;
      }

      .online-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--muted-foreground);
      }

      .online-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      .menu-toggle {
        display: none;
        background: none;
        border: none;
        color: var(--foreground);
        cursor: pointer;
        padding: 8px;
        border-radius: var(--radius);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .menu-toggle:hover {
        background: var(--secondary);
        transform: scale(1.1);
      }

      .menu-toggle:active {
        transform: scale(0.95);
      }

      .menu-toggle svg {
        width: 24px;
        height: 24px;
      }

      .messages-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      .messages-container {
        height: 100%;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
      }

      .messages-container::-webkit-scrollbar {
        width: 8px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
        transition: background 0.2s ease;
      }

      .messages-container::-webkit-scrollbar-thumb:hover {
        background: var(--ring);
      }

      .message {
        margin-bottom: 16px;
        animation: fadeInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        opacity: 0;
        position: relative;
        display: flex;
        gap: 12px;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }

      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: white;
      }

      .message-body {
        flex: 1;
        min-width: 0;
      }

      .message-content {
        display: inline-block;
        max-width: 100%;
        padding: 12px 16px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        word-wrap: break-word;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
      }

      .message-content:hover {
        border-color: var(--ring);
        box-shadow: 0 4px 12px oklch(0 0 0 / 8%);
      }

      .message-content:hover .message-actions {
        opacity: 1;
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .message-username {
        font-weight: 600;
        font-size: 14px;
        transition: transform 0.2s ease;
      }

      .message-time {
        font-size: 11px;
        color: var(--muted-foreground);
      }

      .message-text {
        font-size: 14px;
        line-height: 1.5;
        color: var(--foreground);
      }

      .message-text a {
        color: #3b82f6;
        text-decoration: none;
        transition: all 0.2s ease;
        position: relative;
      }

      .message-text a::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: #3b82f6;
        transition: width 0.3s ease;
      }

      .message-text a:hover::after {
        width: 100%;
      }

      .message-text a:hover {
        opacity: 0.8;
      }

      .message-text img {
        max-width: 100%;
        max-height: 400px;
        height: auto;
        border-radius: 8px;
        margin-top: 8px;
        animation: fadeIn 0.4s ease;
        transition: transform 0.3s ease;
        cursor: pointer;
      }

      .message-text img:hover {
        transform: scale(1.02);
      }

      .message-text strong {
        font-weight: 600;
      }

      .message-text em {
        font-style: italic;
      }

      .message-text code {
        background: var(--muted);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
      }

      .message-actions {
        position: absolute;
        top: -12px;
        right: 4px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 4px;
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.2s ease;
        box-shadow: 0 2px 8px oklch(0 0 0 / 10%);
        max-width: calc(100% - 16px);
        flex-wrap: nowrap;
      }

      .message-action-btn {
        background: none;
        border: none;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }

      .message-action-btn:hover {
        background: var(--secondary);
        color: var(--foreground);
        transform: scale(1.1);
      }

      .message-action-btn svg {
        width: 16px;
        height: 16px;
      }

      .message-reactions {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .reaction {
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .reaction:hover {
        background: var(--accent);
        transform: scale(1.05);
      }

      .reaction.active {
        background: var(--accent);
        border-color: var(--ring);
      }

      .scroll-to-bottom {
        position: absolute;
        bottom: 24px;
        right: 24px;
        background: var(--primary);
        color: var(--primary-foreground);
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px oklch(0 0 0 / 15%);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        opacity: 0;
        pointer-events: none;
      }

      .scroll-to-bottom.visible {
        opacity: 1;
        pointer-events: all;
      }

      .scroll-to-bottom:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 6px 16px oklch(0 0 0 / 20%);
      }

      .scroll-to-bottom svg {
        width: 24px;
        height: 24px;
      }

      .typing-indicator-container {
        padding: 0 24px 12px;
        min-height: 24px;
        animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s backwards;
      }

      .typing-indicator {
        font-size: 13px;
        color: var(--muted-foreground);
        font-style: italic;
        animation: fadeIn 0.3s ease;
      }

      .input-container {
        padding: 16px 24px;
        border-top: 1px solid var(--border);
        background: var(--card);
        animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s backwards;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .input-box {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .input-wrapper {
        flex: 1;
        position: relative;
      }

      .input-box textarea {
        width: 100%;
        padding: 12px 80px 12px 16px;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--foreground);
        font-size: 14px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 120px;
        min-height: 44px;
      }

      .input-box textarea:focus {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px oklch(0.708 0 0 / 10%);
        transform: translateY(-1px);
      }

      .input-box textarea::placeholder {
        color: var(--muted-foreground);
      }

      .input-actions {
        position: absolute;
        right: 8px;
        bottom: 8px;
        display: flex;
        gap: 4px;
      }

      .input-action-btn {
        background: none;
        border: none;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }

      .input-action-btn:hover {
        background: var(--muted);
        color: var(--foreground);
        transform: scale(1.1);
      }

      .input-action-btn svg {
        width: 18px;
        height: 18px;
      }

      .char-counter {
        position: absolute;
        right: 12px;
        bottom: -20px;
        font-size: 11px;
        color: var(--muted-foreground);
      }

      .char-counter.warning {
        color: #f97316;
      }

      .char-counter.danger {
        color: #ef4444;
      }

      .send-button {
        padding: 12px 24px;
        background: var(--primary);
        color: var(--primary-foreground);
        border: none;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }

      .send-button:hover {
        opacity: 0.9;
        transform: translateY(-3px);
        box-shadow: 0 6px 16px oklch(0 0 0 / 12%);
      }

      .send-button:active {
        transform: translateY(-1px);
      }

      .send-button svg {
        width: 16px;
        height: 16px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .send-button:hover svg {
        transform: translateX(2px) rotate(-15deg);
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal {
        background: var(--card);
        border-radius: var(--radius);
        padding: 24px;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--border);
        animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 40px oklch(0 0 0 / 20%);
        max-height: 90vh;
        overflow-y: auto;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-header {
        margin-bottom: 20px;
      }

      .modal-header h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .modal-header p {
        font-size: 14px;
        color: var(--muted-foreground);
      }

      .modal-content {
        margin-bottom: 20px;
      }

      .user-input-group {
        margin-bottom: 16px;
      }

      .user-input-group:last-child {
        margin-bottom: 0;
      }

      .user-input-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--foreground);
        margin-bottom: 8px;
      }

      .input-wrapper-modal {
        position: relative;
      }

      .input-wrapper-modal input,
      .input-wrapper-modal select {
        width: 100%;
        padding: 12px 14px;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--foreground);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        outline: none;
      }

      .input-wrapper-modal input:focus,
      .input-wrapper-modal select:focus {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px oklch(0.708 0 0 / 10%);
        transform: translateY(-1px);
      }

      .input-wrapper-modal input::placeholder {
        color: var(--muted-foreground);
      }

      .color-preview {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid var(--border);
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .input-wrapper-modal select:focus + .color-preview {
        transform: translateY(-50%) scale(1.1);
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .modal-buttons button {
        flex: 1;
        padding: 12px;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: none;
      }

      .btn-primary {
        background: var(--primary);
        color: var(--primary-foreground);
      }

      .btn-secondary {
        background: var(--secondary);
        color: var(--secondary-foreground);
        border: 1px solid var(--border);
      }

      .btn-primary:hover,
      .btn-secondary:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px oklch(0 0 0 / 10%);
      }

      .btn-primary:active,
      .btn-secondary:active {
        transform: translateY(0);
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--muted-foreground);
        padding: 40px;
        text-align: center;
        animation: fadeIn 0.6s ease;
      }

      .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--foreground);
      }

      .empty-state p {
        font-size: 14px;
      }

      .skeleton-container {
        padding: 24px;
        display: flex;
        flex-direction: column-reverse;
        gap: 16px;
      }

      .skeleton-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 70%;
        animation: fadeIn 0.3s ease;
      }

      .skeleton-header {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          var(--muted) 25%,
          var(--secondary) 50%,
          var(--muted) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 2s ease-in-out infinite;
        border-radius: var(--radius);
      }

      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .skeleton-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }

      .skeleton-username {
        width: 80px;
        height: 14px;
        border-radius: 4px;
      }

      .skeleton-text {
        width: 100%;
        height: 60px;
        border-radius: var(--radius);
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          z-index: 100;
          transform: translateX(-100%);
          animation: none;
        }

        .sidebar.open {
          transform: translateX(0);
          box-shadow: 4px 0 12px oklch(0 0 0 / 20%);
        }

        .menu-toggle {
          display: flex;
        }

        .message-content {
          max-width: 85%;
        }

        .chat-header {
          padding: 12px 16px;
        }

        .input-container {
          padding: 12px 16px;
        }

        .messages-container {
          padding: 16px;
        }

        .send-button span {
          display: none;
        }

        .send-button {
          padding: 12px 16px;
        }

        .scroll-to-bottom {
          bottom: 16px;
          right: 16px;
          width: 40px;
          height: 40px;
        }

        .scroll-to-bottom svg {
          width: 20px;
          height: 20px;
        }
      }

      @media (max-width: 480px) {
        .logo {
          font-size: 18px;
        }

        .logo svg {
          width: 24px;
          height: 24px;
        }

        .modal {
          width: 95%;
          padding: 20px;
        }

        .modal-header h3 {
          font-size: 18px;
        }

        .message-text img {
          max-height: 300px;
        }
      }

      .hidden {
        display: none;
      }

      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 99;
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .backdrop.active {
        display: block;
      }
      /* Style the modal error messages */
      .modal-error-message {
        display: none;
        color: var(--destructive);
        font-size: 13px;
        margin-top: 12px;
        padding: 10px 12px;
        background: var(--destructive);
        background: oklch(0.577 0.245 27.325 / 0.1);
        border-radius: var(--radius);
        border-left: 3px solid var(--destructive);
        font-weight: 500;
      }

      .modal-error-message:not(:empty) {
        display: block;
      }

      /* Style the auth modal buttons container */
      .modal-buttons-auth {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .modal-buttons-auth button {
        flex: 1;
        padding: 12px;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: none;
      }

      /* Style input wrapper properly */
      .input-wrapper {
        position: relative;
        width: 100%;
      }

      /* Ensure select elements match input styling */
      .input-wrapper select {
        width: 100%;
        padding: 12px 14px;
        padding-right: 48px;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--foreground);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        outline: none;
        cursor: pointer;
        appearance: none;
      }

      .input-wrapper select:focus {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px oklch(0.708 0 0 / 10%);
        transform: translateY(-1px);
      }

      /* Add dropdown arrow for select */
      .input-wrapper select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
      }

      /* Style the scroll to bottom button properly when visible */
      .scroll-to-bottom {
        position: absolute;
        bottom: 24px;
        right: 24px;
        background: var(--primary);
        color: var(--primary-foreground);
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px oklch(0 0 0 / 15%);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: translateY(10px);
      }

      .scroll-to-bottom.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translateY(0);
      }

      /* Improve message avatar rendering */
      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: white;
        background: var(--muted-foreground);
      }

      /* Ensure message body takes full width */
      .message-body {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
      }

      /* Fix message content to be inline-block */
      .message-content {
        display: inline-block;
        max-width: 100%;
        padding: 12px 16px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        word-wrap: break-word;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        align-self: flex-start;
      }

      /* Style the room icon properly */
      .room-icon {
        width: 20px;
        height: 20px;
        color: var(--muted-foreground);
        flex-shrink: 0;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        stroke: currentColor;
        fill: none;
      }

      /* Ensure proper message structure */
      .message {
        margin-bottom: 16px;
        animation: fadeInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        opacity: 0;
        position: relative;
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      /* Style disabled buttons */
      .send-button:disabled,
      .btn-primary:disabled,
      .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      /* Improve char counter visibility */
      .char-counter {
        position: absolute;
        right: 12px;
        bottom: -22px;
        font-size: 11px;
        color: var(--muted-foreground);
        font-weight: 500;
        transition: color 0.2s ease;
      }

      .char-counter.warning {
        color: #f97316;
        font-weight: 600;
      }

      .char-counter.danger {
        color: var(--destructive);
        font-weight: 600;
      }

      /* Ensure modal overlay is properly centered */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
        padding: 20px;
      }

      /* Fix modal scrolling */
      .modal {
        background: var(--card);
        border-radius: var(--radius);
        padding: 24px;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--border);
        animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 40px oklch(0 0 0 / 20%);
        max-height: calc(90vh - 40px);
        overflow-y: auto;
      }

      /* Style the typing indicator properly */
      .typing-indicator {
        font-size: 13px;
        color: var(--muted-foreground);
        font-style: italic;
        animation: fadeIn 0.3s ease;
        min-height: 18px;
      }

      /* Ensure empty state is centered */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 400px;
        color: var(--muted-foreground);
        padding: 40px;
        text-align: center;
        animation: fadeIn 0.6s ease;
      }

      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 24px;
        opacity: 0.3;
        stroke-width: 1.5;
        animation: float 3s ease-in-out infinite;
      }

      .empty-state h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--foreground);
      }

      .empty-state p {
        font-size: 14px;
        color: var(--muted-foreground);
        max-width: 320px;
      }
      input[type='text'],
      input[type='password'],
      input[type='email'],
      input[type='number'],
      input[type='file'],
      textarea,
      select {
        width: 100%;
        padding: 12px 14px;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--foreground);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        outline: none;
      }

      input[type='text']:focus,
      input[type='password']:focus,
      input[type='email']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px oklch(0.708 0 0 / 10%);
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <div class="backdrop" id="backdrop"></div>

    <div class="app-container">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L2.5 21.5L7 20.6622C8.47087 21.513 10.1786 22 12 22Z"
                stroke-linejoin="round"
                stroke-linecap="round"
                stroke-width="1.5"
                stroke="currentColor"
                fill="none"
              />
            </svg>
            ArrowChat
          </div>
          <button class="settings-btn" id="settingsBtn" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894z"
                stroke-linejoin="round"
                stroke-linecap="round"
                stroke-width="1.5"
                stroke="currentColor"
                fill="none"
              />
              <path
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                stroke-linejoin="round"
                stroke-linecap="round"
                stroke-width="1.5"
                stroke="currentColor"
                fill="none"
              />
            </svg>
          </button>
        </div>

        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">User</div>
            <div class="user-status">
              <span class="status-dot"></span>
              Online
            </div>
          </div>
        </div>

        <div class="rooms-section">
          <div class="rooms-header">
            <h3>Rooms</h3>
            <button class="add-room-btn" id="addRoomBtn" title="Join room">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
          </div>
          <div id="roomsList"></div>
        </div>
      </aside>

      <main class="main-content">
        <header class="chat-header">
          <button class="menu-toggle" id="menuToggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12" />
              <line x1="3" y1="6" x2="21" y2="6" />
              <line x1="3" y1="18" x2="21" y2="18" />
            </svg>
          </button>
          <div class="chat-header-info">
            <h2 id="currentRoomName">general</h2>
            <div class="online-indicator">
              <span class="online-dot"></span>
              <span id="onlineCount">0 online</span>
            </div>
          </div>
        </header>

        <div class="messages-wrapper">
          <div class="messages-container" id="messagesContainer">
            <div class="skeleton-container" id="skeletonLoader">
              <div class="skeleton-message">
                <div class="skeleton-header">
                  <div class="skeleton skeleton-avatar"></div>
                  <div class="skeleton skeleton-username"></div>
                </div>
                <div class="skeleton skeleton-text"></div>
              </div>
              <div class="skeleton-message">
                <div class="skeleton-header">
                  <div class="skeleton skeleton-avatar"></div>
                  <div class="skeleton skeleton-username"></div>
                </div>
                <div class="skeleton skeleton-text"></div>
              </div>
            </div>
          </div>

          <button class="scroll-to-bottom" id="scrollToBottom">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
        </div>

        <div class="typing-indicator-container">
          <div class="typing-indicator" id="typingStatus"></div>
        </div>

        <div class="input-container">
          <div class="input-box">
            <div class="input-wrapper">
              <textarea id="chatInput" placeholder="Type a message..." rows="1"></textarea>
              <div class="input-actions">
                <button class="input-action-btn" id="imageBtn" title="Paste or upload image">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21 15 16 10 5 21" />
                  </svg>
                </button>
              </div>
              <div class="char-counter" id="charCounter">0/200</div>
            </div>
            <button class="send-button" id="sendButton">
              <span>Send</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
              </svg>
            </button>
          </div>
        </div>
      </main>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display: none" />
    <div id="modalContainer"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      class arrowchat {
        constructor() {
          this.socket = io('https://qs03x443-3000.usw3.devtunnels.ms/');
          this.ip = '';
          this.currentRoom = 'general';
          this.userRooms = this.loadUserRooms();
          this.username = '';
          this.userColor = this.loadUserColor();
          this.isLoading = false;
          this.isAuthenticated = false;
          this.typingTimeout = null;
          this.elements = {
            appContainer: document.querySelector('.app-container'),
            messagesContainer: document.getElementById('messagesContainer'),
            chatInput: document.getElementById('chatInput'),
            sendButton: document.getElementById('sendButton'),
            typingStatus: document.getElementById('typingStatus'),
            currentRoomName: document.getElementById('currentRoomName'),
            roomsList: document.getElementById('roomsList'),
            addRoomBtn: document.getElementById('addRoomBtn'),
            modalContainer: document.getElementById('modalContainer'),
            settingsBtn: document.getElementById('settingsBtn'),
            userName: document.getElementById('userName'),
            userAvatar: document.getElementById('userAvatar'),
            sidebar: document.getElementById('sidebar'),
            menuToggle: document.getElementById('menuToggle'),
            backdrop: document.getElementById('backdrop'),
            skeletonLoader: document.getElementById('skeletonLoader'),
          };
          this.init();
        }

        async init() {
          this.elements.appContainer.style.opacity = '0';
          await this.getIP();

          if (!this.isAuthenticated) {
            this.showLoginModal();
          }
        }
        editMessage(messageId, data) {
          const newText = prompt('Edit message:', data.text);
          if (newText && newText.trim() && newText !== data.text) {
            this.socket.emit('editMessage', { messageId, newText: newText.trim() }, (response) => {
              if (!response.success) {
                alert(response.message || 'Failed to edit message');
              }
            });
          }
        }
        deleteMessage(messageId) {
          if (confirm('Delete this message?')) {
            this.socket.emit('deleteMessage', { messageId }, (response) => {
              if (!response.success) {
                alert(response.message || 'Failed to delete message');
              }
            });
          }
        }
        sendMessageWithImage(imageData) {
          const msg = this.elements.chatInput.value.trim();
          const color = this.userColor;
          const username = this.username;

          this.socket.emit('sendMessage', {
            text: msg,
            imageData: imageData,
            color: color,
            username: username,
            timestamp: Date.now(),
          });

          this.elements.chatInput.value = '';
          this.elements.chatInput.style.height = 'auto';
          this.socket.emit('typing', { isTyping: false });
        }
        renderReactions(reactions, messageId) {
          const reactionsDiv = document.createElement('div');
          reactionsDiv.className = 'message-reactions';

          if (!reactions || Object.keys(reactions).length === 0) {
            return reactionsDiv;
          }

          Object.entries(reactions).forEach(([emoji, users]) => {
            const reactionSpan = document.createElement('span');
            reactionSpan.className = 'reaction';
            if (users.includes(this.username)) {
              reactionSpan.classList.add('active');
            }
            reactionSpan.innerHTML = `${emoji} ${users.length}`;
            reactionSpan.title = users.join(', ');
            reactionSpan.onclick = () => this.toggleReaction(messageId, emoji);
            reactionsDiv.appendChild(reactionSpan);
          });

          return reactionsDiv;
        }
        toggleReaction(messageId, emoji) {
          this.socket.emit('toggleReaction', { messageId, emoji }, (response) => {
            if (!response.success) {
              console.error('Failed to toggle reaction:', response.message);
            }
          });
        }
        showReactionPicker(messageId, contentDiv) {
          const emojis = ['ðŸ‘', 'ðŸ˜‚', 'ðŸŽ‰', 'ðŸ‘€', 'â¤ï¸', 'ðŸ”¥', 'ðŸ’€','ðŸ¥­'];
          const picker = document.createElement('div');

          picker.style.cssText = `
                        position: absolute;
                        background: var(--card);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 8px;
                        display: flex;
                        gap: 8px;
                        box-shadow: 0 4px 12px oklch(0 0 0 / 15%);
                        z-index: 1001;
                    `;

          emojis.forEach((emoji) => {
            const btn = document.createElement('button');
            btn.textContent = emoji;
            btn.style.cssText =
              'background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; border-radius: 4px; transition: transform 0.2s ease;';
            btn.onmouseover = () => (btn.style.transform = 'scale(1.2)');
            btn.onmouseout = () => (btn.style.transform = 'scale(1)');
            btn.onclick = () => {
              this.toggleReaction(messageId, emoji);
              picker.remove();
            };
            picker.appendChild(btn);
          });

          document.body.appendChild(picker);

          const rect = contentDiv.getBoundingClientRect();
          const pickerRect = picker.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const padding = 10;

          let top = rect.top + window.scrollY - pickerRect.height - 4;
          let left = rect.right - pickerRect.width;

          if (left < padding) {
            left = padding;
          }
          if (left + pickerRect.width > viewportWidth - padding) {
            left = viewportWidth - pickerRect.width - padding;
          }
          if (top < window.scrollY + padding) {
            top = rect.bottom + window.scrollY + 4;
          }

          picker.style.top = `${top}px`;
          picker.style.left = `${left}px`;

          setTimeout(() => {
            document.addEventListener(
              'click',
              function removeHandler(e) {
                if (!picker.contains(e.target)) {
                  picker.remove();
                  document.removeEventListener('click', removeHandler);
                }
              },
              { once: true }
            );
          }, 0);
        }
        async handleImageUpload(file) {
          if (!file || !file.type.startsWith('image/')) return;

          if (file.size > 80 * 1024) {
            alert('Image too large. Maximum size is 80KB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              const maxSize = 800;
              if (width > height && width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              } else if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const imageData = canvas.toDataURL('image/jpeg', 0.8);
              this.sendMessageWithImage(imageData);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
        async getIP() {
          return new Promise((resolve) => {
            if (this.ip) {
              resolve(this.ip);
              return;
            }
            this.socket.once('ipAddress', ({ ip }) => {
              this.ip = ip;
              resolve(ip);
            });
          });
        }

        startApp() {
          this.isAuthenticated = true;
          this.elements.appContainer.style.opacity = '1';
          this.elements.modalContainer.innerHTML = '';
          this.updateUserDisplay();
          this.setupEventListeners();
          this.renderRooms();
          this.loadRoom(this.currentRoom);
        }

        showSkeleton() {
          this.elements.skeletonLoader.classList.remove('hidden');
        }

        hideSkeleton() {
          this.elements.skeletonLoader.classList.add('hidden');
        }

        loadUserRooms() {
          try {
            const rooms = JSON.parse(localStorage.getItem('arrowchat_rooms')) || ['general'];
            return [...new Set(rooms)];
          } catch {
            return ['general'];
          }
        }

        saveUserRooms() {
          try {
            localStorage.setItem('arrowchat_rooms', JSON.stringify(this.userRooms));
          } catch (error) {
            console.error('Failed to save rooms:', error);
          }
        }

        loadUserColor() {
          try {
            return localStorage.getItem('arrowchat_color') || '#ef4444';
          } catch {
            return '#ef4444';
          }
        }

        saveUserColor(color) {
          try {
            localStorage.setItem('arrowchat_color', color);
            this.userColor = color;
            this.updateUserDisplay();
          } catch (error) {
            console.error('Failed to save color:', error);
          }
        }

        updateUserDisplay() {
          this.elements.userName.textContent = this.username;
          this.elements.userAvatar.textContent = this.username.charAt(0).toUpperCase();
          this.elements.userAvatar.style.backgroundColor = this.userColor;
        }

        formatTimestamp(timestamp) {
          const date = new Date(timestamp);
          const now = new Date();
          const diff = now - date;

          if (diff < 60000) return 'Just now';
          if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
          if (diff < 86400000)
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        renderMessage(data) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message';
          messageDiv.setAttribute('data-message-id', data.id);

          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';

          const headerDiv = document.createElement('div');
          headerDiv.className = 'message-header';

          const usernameSpan = document.createElement('span');
          usernameSpan.className = 'message-username';
          usernameSpan.style.color = data.color;
          usernameSpan.textContent = data.username;

          const timeSpan = document.createElement('span');
          timeSpan.className = 'message-time';
          let timeText = this.formatTimestamp(data.timestamp);
          if (data.edited) {
            timeText += ' (edited)';
          }
          timeSpan.textContent = timeText;

          headerDiv.appendChild(usernameSpan);
          headerDiv.appendChild(timeSpan);

          const textDiv = document.createElement('div');
          textDiv.className = 'message-text';
          if (data.text) {
            textDiv.textContent = data.text;
          }

          // Handle images
          if (data.image_data) {
            const img = document.createElement('img');
            img.src = data.image_data;
            img.alt = 'Message image';
            img.onclick = () => {
              const modal = document.createElement('div');
              modal.style.cssText =
                'position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer;';
              const modalImg = document.createElement('img');
              modalImg.src = data.image_data;
              modalImg.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
              modal.appendChild(modalImg);
              modal.onclick = () => modal.remove();
              document.body.appendChild(modal);
            };
            textDiv.appendChild(img);
          }
          const reactionsDiv = this.renderReactions(data.reactions || {}, data.id);
          textDiv.appendChild(reactionsDiv);
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'message-actions';
          const reactionBtn = document.createElement('button');
          reactionBtn.className = 'message-action-btn';
          reactionBtn.title = 'Add reaction';
          reactionBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>`;
          reactionBtn.onclick = () => this.showReactionPicker(data.id, contentDiv);
          actionsDiv.appendChild(reactionBtn);
          if (data.username === this.username) {
            const editBtn = document.createElement('button');
            editBtn.className = 'message-action-btn';
            editBtn.title = 'Edit message';
            editBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
            editBtn.onclick = () => this.editMessage(data.id, data);
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'message-action-btn';
            deleteBtn.title = 'Delete message';
            deleteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
            deleteBtn.onclick = () => this.deleteMessage(data.id);
            actionsDiv.appendChild(deleteBtn);
          }

          contentDiv.appendChild(headerDiv);
          contentDiv.appendChild(textDiv);
          contentDiv.appendChild(actionsDiv);
          messageDiv.appendChild(contentDiv);

          return messageDiv;
        }

        showEmptyState() {
          const emptyStateHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <h3>No messages yet</h3>
                            <p>Be the first to start the conversation</p>
                        </div>`;
          this.elements.messagesContainer.innerHTML = emptyStateHTML;
        }

        loadRoom(roomName) {
          if (this.isLoading) return;

          this.isLoading = true;
          this.currentRoom = roomName;
          this.elements.currentRoomName.textContent = roomName;

          document.querySelectorAll('.room-item').forEach((r) => r.classList.remove('active'));
          const activeRoom = document.querySelector(`.room-item[data-room="${roomName}"]`);
          if (activeRoom) activeRoom.classList.add('active');

          this.showSkeleton();
          this.socket.emit('joinRoom', { room: roomName });
        }

        renderRooms() {
          this.elements.roomsList.innerHTML = '';
          this.userRooms.forEach((room, index) => {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-item';
            if (room === this.currentRoom) {
              roomDiv.classList.add('active');
            }
            roomDiv.dataset.room = room;
            roomDiv.style.animationDelay = `${0.1 + index * 0.05}s`;

            roomDiv.innerHTML = `
                            <svg class="room-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <span class="room-name">${room}</span>`;

            roomDiv.addEventListener('click', () => {
              if (this.currentRoom === room) return;
              this.loadRoom(room);
              this.closeSidebar();
            });

            this.elements.roomsList.appendChild(roomDiv);
          });
        }

        showModal(title, description, content, buttons, allowOverlayClose = true) {
          const modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h3>${title}</h3>
                                    ${description ? `<p>${description}</p>` : ''}
                                </div>
                                <div class="modal-content">${content}</div>
                                ${buttons}
                            </div>
                        </div>`;

          this.elements.modalContainer.innerHTML = modalHTML;

          const overlay = this.elements.modalContainer.querySelector('.modal-overlay');
          if (allowOverlayClose) {
            overlay.addEventListener('click', (e) => {
              if (e.target === overlay) this.elements.modalContainer.innerHTML = '';
            });
          }
        }

        showLoginModal() {
          const content = `
                        <div class="user-input-group">
                            <label for="usernameInput">Username</label>
                            <input type="text" id="usernameInput" placeholder="Enter your username" required>
                        </div>
                        <div class="user-input-group">
                            <label for="passwordInput">Password</label>
                            <input type="password" id="passwordInput" placeholder="Enter your password" required>
                        </div>
                        <div class="modal-error-message" id="authError"></div>`;
          const buttons = `
                        <div class="modal-buttons-auth">
                            <button class="btn-secondary" id="registerBtn">Register</button>
                            <button class="btn-primary" id="loginBtn">Login</button>
                        </div>`;

          this.showModal(
            'Welcome',
            'Please login or register to continue',
            content,
            buttons,
            false
          );
          if (localStorage.getItem('info')) {
            console.log(localStorage.getItem('info'));
            this.handleAuth('login');
          } else {
            document
              .getElementById('loginBtn')
              .addEventListener('click', () => this.handleAuth('login'));
            document
              .getElementById('registerBtn')
              .addEventListener('click', () => this.handleAuth('register'));
          }
        }

        handleAuth(action) {
          const info = JSON.parse(localStorage.getItem('info'));
          let username = document.getElementById('usernameInput').value.trim();
          let password = document.getElementById('passwordInput').value.trim();
          const errorDiv = document.getElementById('authError');
          if (info) {
            username = info.username;
            password = atob(info.password);
          }
          if (!username || !password) {
            errorDiv.textContent = 'Username and password are required.';
            return;
          }

          errorDiv.textContent = '';

          this.socket.emit(action, { username, password }, (response) => {
            if (response.success) {
              if (action === 'login') {
                this.username = response.user.username;
                localStorage.setItem(
                  'info',
                  JSON.stringify({ username: this.username, password: btoa(password) })
                );
                this.startApp();
              } else {
                this.showLoginModal();
                document.getElementById('authError').textContent =
                  'Registration successful! Please log in.';
              }
            } else {
              errorDiv.textContent = response.message;
            }
          });
        }

        showSettingsModal() {
          const content = `
                        <div class="user-input-group">
                            <label for="settingsColorInput">Display Color</label>
                            <div class="input-wrapper">
                                <select id="settingsColorInput">
                                    <option value="#ef4444" ${
                                      this.userColor === '#ef4444' ? 'selected' : ''
                                    }>Red</option>
                                    <option value="#3b82f6" ${
                                      this.userColor === '#3b82f6' ? 'selected' : ''
                                    }>Blue</option>
                                    <option value="#22c55e" ${
                                      this.userColor === '#22c55e' ? 'selected' : ''
                                    }>Green</option>
                                    <option value="#eab308" ${
                                      this.userColor === '#eab308' ? 'selected' : ''
                                    }>Yellow</option>
                                    <option value="#a855f7" ${
                                      this.userColor === '#a855f7' ? 'selected' : ''
                                    }>Purple</option>
                                    <option value="#06b6d4" ${
                                      this.userColor === '#06b6d4' ? 'selected' : ''
                                    }>Cyan</option>
                                    <option value="#f97316" ${
                                      this.userColor === '#f97316' ? 'selected' : ''
                                    }>Orange</option>
                                    <option value="#ec4899" ${
                                      this.userColor === '#ec4899' ? 'selected' : ''
                                    }>Pink</option>
                                </select>
                                <div class="color-preview" id="settingsColorPreview" style="background-color: ${
                                  this.userColor
                                };"></div>
                            </div>
                        </div>`;
          const buttons = `
                        <div class="modal-buttons">
                            <button class="btn-secondary" id="modalCancel">Cancel</button>
                            <button class="btn-primary" id="logout">Logout</button>
                            <button class="btn-primary" id="modalConfirm">Save</button>
                        </div>`;

          this.showModal('Settings', 'Update your display color', content, buttons);

          const colorSelect = document.getElementById('settingsColorInput');
          const colorPreview = document.getElementById('settingsColorPreview');

          colorSelect.addEventListener(
            'change',
            () => (colorPreview.style.backgroundColor = colorSelect.value)
          );
          document
            .getElementById('modalCancel')
            .addEventListener('click', () => (this.elements.modalContainer.innerHTML = ''));
          document.getElementById('modalConfirm').addEventListener('click', () => {
            this.saveUserColor(colorSelect.value);
            this.elements.modalContainer.innerHTML = '';
          });
          document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('info');
            this.isAuthenticated = false;
            this.elements.appContainer.style.opacity = '0';
            this.showLoginModal();
          });
        }

        showJoinRoomModal() {
          const content = `
                        <div class="user-input-group">
                            <label for="roomNameInput">Room Name</label>
                            <input type="text" id="roomNameInput" placeholder="e.g. developers" autofocus />
                        </div>`;
          const buttons = `
                        <div class="modal-buttons">
                            <button class="btn-secondary" id="modalCancel">Cancel</button>
                            <button class="btn-primary" id="modalConfirm">Join</button>
                        </div>`;

          this.showModal(
            'Join Room',
            'Enter the name of the room you want to join',
            content,
            buttons
          );

          document
            .getElementById('modalCancel')
            .addEventListener('click', () => (this.elements.modalContainer.innerHTML = ''));
          document.getElementById('modalConfirm').addEventListener('click', () => {
            const roomInput = document.getElementById('roomNameInput');
            const roomName = roomInput.value.trim().toLowerCase();
            if (roomName && !this.userRooms.includes(roomName)) {
              this.userRooms.push(roomName);
              this.saveUserRooms();
              this.renderRooms();
              this.loadRoom(roomName);
            } else if (this.userRooms.includes(roomName)) {
              this.loadRoom(roomName);
            }
            this.elements.modalContainer.innerHTML = '';
          });
        }

        sendMessage() {
          const msg = this.elements.chatInput.value.trim();
          if (msg) {
            this.socket.emit('sendMessage', {
              text: msg,
              color: this.userColor,
              username: this.username,
              timestamp: Date.now(),
            });
            this.elements.chatInput.value = '';
            this.elements.chatInput.style.height = 'auto';
            this.socket.emit('typing', { isTyping: false });
          }
        }

        closeSidebar() {
          this.elements.sidebar.classList.remove('open');
          this.elements.backdrop.classList.remove('active');
        }

        openSidebar() {
          this.elements.sidebar.classList.add('open');
          this.elements.backdrop.classList.add('active');
        }

        setupEventListeners() {
          this.elements.chatInput.addEventListener('input', (e) => {
            document.getElementById('charCounter').innerHTML =
              this.elements.chatInput.value.trim().length + ' / 200';
            e.target.style.height = 'auto';
            e.target.style.height = `${Math.min(e.target.scrollHeight, 120)}px`;

            if (this.typingTimeout) clearTimeout(this.typingTimeout);

            this.socket.emit('typing', { isTyping: true });

            this.typingTimeout = setTimeout(() => {
              this.socket.emit('typing', { isTyping: false });
            }, 3000);
          });

          this.elements.chatInput.addEventListener('blur', () => {
            if (this.typingTimeout) clearTimeout(this.typingTimeout);
            this.socket.emit('typing', { isTyping: false });
          });

          this.elements.sendButton.addEventListener('click', () => this.sendMessage());

          this.elements.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
              document.getElementById('charCounter').innerHTML ='0 / 200';
            }
          });

          this.elements.addRoomBtn.addEventListener('click', () => this.showJoinRoomModal());
          this.elements.settingsBtn.addEventListener('click', () => this.showSettingsModal());
          this.elements.userAvatar.addEventListener('click', () => this.showSettingsModal());
          this.elements.menuToggle.addEventListener('click', () => this.openSidebar());
          this.elements.backdrop.addEventListener('click', () => this.closeSidebar());

          const imageInput = document.getElementById('imageInput');
          const imageBtn = document.getElementById('imageBtn');
          if (imageBtn) {
            imageBtn.addEventListener('click', () => imageInput.click());
          }
          if (imageInput) {
            imageInput.addEventListener('change', (e) => {
              const file = e.target.files[0];
              if (file) {
                this.handleImageUpload(file);
                imageInput.value = '';
              }
            });
          }

          document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
              if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                this.handleImageUpload(file);
                break;
              }
            }
          });
          this.socket.on('online', ({ online }) => {
            document.getElementById('onlineCount').textContent = `${online} online`;
          });
          this.socket.on('loaded', ({ list }) => {
            this.isLoading = false;
            this.hideSkeleton();
            this.elements.messagesContainer.innerHTML = '';

            if (list && list.length > 0) {
              const messagesFragment = document.createDocumentFragment();
              list.forEach((data) => {
                const messageDiv = this.renderMessage(data);
                messagesFragment.appendChild(messageDiv);
              });
              this.elements.messagesContainer.append(messagesFragment);
            } else {
              this.showEmptyState();
            }

            const container = this.elements.messagesContainer;
            container.scrollTop = container.scrollHeight;
          });
          this.socket.on('newMessage', (data) => {
            if (data.room === this.currentRoom) {
              const messageDiv = this.renderMessage(data);
              this.elements.messagesContainer.appendChild(messageDiv);
              const container = this.elements.messagesContainer;
              container.scrollTop = container.scrollHeight;
            }
          });

          this.socket.on('messageUpdated', (data) => {
            if (data.room === this.currentRoom) {
              const messageEl = document.querySelector(`[data-message-id="${data.id}"]`);
              if (messageEl) {
                const newMessageDiv = this.renderMessage(data);
                messageEl.replaceWith(newMessageDiv);
              }
            }
          });

          this.socket.on('messageDeleted', ({ messageId }) => {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
              messageEl.style.animation = 'fadeOut 0.3s ease';
              setTimeout(() => messageEl.remove(), 300);
            }
          });

          this.socket.on('reactionUpdated', ({ messageId, reactions }) => {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
              const reactionsDiv = messageEl.querySelector('.message-reactions');
              if (reactionsDiv) {
                const newReactionsDiv = this.renderReactions(reactions, messageId);
                reactionsDiv.replaceWith(newReactionsDiv);
              } else {
                const textDiv = messageEl.querySelector('.message-text');
                if (textDiv) {
                  const newReactionsDiv = this.renderReactions(reactions, messageId);
                  textDiv.appendChild(newReactionsDiv);
                }
              }
            }
          });

          this.socket.on('typing', ({ typers }) => {
            let typingText = '';
            if (typers) {
              const users = Object.keys(typers).filter((user) => user !== this.username);
              if (users.length > 0) {
                if (users.length === 1) {
                  typingText = `${users[0]} is typing...`;
                } else if (users.length === 2) {
                  typingText = `${users[0]} and ${users[1]} are typing...`;
                } else {
                  typingText = `${users[0]}, ${users[1]}, and ${
                    users.length - 2
                  } others are typing...`;
                }
              }
            }
            this.elements.typingStatus.textContent = typingText;
          });

          this.socket.on('disconnect', () => {
            document.body.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 16px;">
                              <h1 style="font-size: 32px; font-weight: 600;">Disconnected</h1>
                              <p style="color: var(--muted-foreground);">You have been disconnected. Please refresh the page.</p>
                            </div>`;
          });
        }
      }

      new arrowchat();
    </script>
  </body>
</html>
